c5c9f3e3fc08ac3f79af3a8e16c31bf5
const hexToBinary = require('hex-to-binary');
const Block = require('./block');
const { MINE_RATE, GENESIS_DATA } = require('../config');
const cryptoHash = require('../util/crypto-hash');

describe('Block', () => {
    const timestamp = 2000;
    const lastHash = 'foo-hash';
    const hash = 'bar-hash';
    const data = ['blockchain', 'data'];
    const nonce = 1;
    const difficulty = 1;
    const block = new Block({ timestamp, lastHash, hash, data, nonce, difficulty });

    it('has a timestamp,lasthash,hash and data property', () => {
        expect(block.timestamp).toEqual(timestamp);
        expect(block.lastHash).toEqual(lastHash);
        expect(block.hash).toEqual(hash);
        expect(block.data).toEqual(data);
        expect(block.nonce).toEqual(nonce);
        expect(block.difficulty).toEqual(difficulty);
    });

    describe('genesis()', () => {
        const genesisBlock = Block.genesis();
        console.log("genesisBlock--->", genesisBlock);

        it('returns a Block instance', () => {
            expect(genesisBlock instanceof Block).toBe(true);
        });
        it('returns the genesis data', () => {
            expect(genesisBlock).toEqual(GENESIS_DATA);
        });
    });

    describe('mineBlock()', () => {
        const lastBlock = Block.genesis();
        const data = 'mined data';
        const minedBlock = Block.mineBlock({ lastBlock, data });

        it('returns a Block instance', () => {
            expect(minedBlock instanceof Block).toBe(true);
        });
        it('sets the `lastHash` to be the `hash` of the `lastBlock`', () => {
            expect(minedBlock.lastHash).toEqual(lastBlock.hash);
        });
        it('sets the `data`', () => {
            expect(minedBlock.data).toEqual(data);
        });
        it('sets a `timestamp`', () => {
            expect(minedBlock.timestamp).not.toEqual(undefined);
        });
        it('creates a SHA-256 `hash` based on proper inputs', () => {
            expect(minedBlock.hash).toEqual(cryptoHash(minedBlock.timestamp, minedBlock.nonce, minedBlock.difficulty, lastBlock.hash, data));
        });
        it('sets a `hash` that matches the difficulty criteria', () => {
            expect(hexToBinary(minedBlock.hash).substring(0, minedBlock.difficulty)).toEqual('0'.repeat(minedBlock.difficulty));
        });
        it('adjusts the difficulty', () => {
            const possibleResults = [lastBlock.difficulty + 1, lastBlock.difficulty - 1];
            expect(possibleResults.includes(minedBlock.difficulty)).toBe(true);
        });
    });

    describe('adjustDifficulty', () => {
        it('raises the difficulty for a quickly mined block', () => {
            expect(Block.adjustDifficulty({
                originalBlock: block,
                timestamp: block.timestamp + MINE_RATE - 100
            })).toEqual(block.difficulty + 1);
        });
        it('lowers the difficulty for a slowly mined block', () => {
            expect(Block.adjustDifficulty({
                originalBlock: block,
                timestamp: block.timestamp + MINE_RATE + 100
            })).toEqual(block.difficulty - 1);
        });
        it('has a lower limit of 1', () => {
            block.difficulty = -1;
            expect(Block.adjustDifficulty({ originalBlock: block })).toEqual(1);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJsb2NrLnRlc3QuanMiXSwibmFtZXMiOlsiaGV4VG9CaW5hcnkiLCJyZXF1aXJlIiwiQmxvY2siLCJNSU5FX1JBVEUiLCJHRU5FU0lTX0RBVEEiLCJjcnlwdG9IYXNoIiwiZGVzY3JpYmUiLCJ0aW1lc3RhbXAiLCJsYXN0SGFzaCIsImhhc2giLCJkYXRhIiwibm9uY2UiLCJkaWZmaWN1bHR5IiwiYmxvY2siLCJpdCIsImV4cGVjdCIsInRvRXF1YWwiLCJnZW5lc2lzQmxvY2siLCJnZW5lc2lzIiwiY29uc29sZSIsImxvZyIsInRvQmUiLCJsYXN0QmxvY2siLCJtaW5lZEJsb2NrIiwibWluZUJsb2NrIiwibm90IiwidW5kZWZpbmVkIiwic3Vic3RyaW5nIiwicmVwZWF0IiwicG9zc2libGVSZXN1bHRzIiwiaW5jbHVkZXMiLCJhZGp1c3REaWZmaWN1bHR5Iiwib3JpZ2luYWxCbG9jayJdLCJtYXBwaW5ncyI6IkFBQUEsTUFBTUEsY0FBWUMsUUFBUSxlQUFSLENBQWxCO0FBQ0EsTUFBTUMsUUFBTUQsUUFBUSxTQUFSLENBQVo7QUFDQSxNQUFNLEVBQUNFLFNBQUQsRUFBV0MsWUFBWCxLQUF5QkgsUUFBUSxXQUFSLENBQS9CO0FBQ0EsTUFBTUksYUFBV0osUUFBUSxxQkFBUixDQUFqQjs7QUFFQUssU0FBUyxPQUFULEVBQWlCLE1BQUk7QUFDakIsVUFBTUMsWUFBVSxJQUFoQjtBQUNBLFVBQU1DLFdBQVMsVUFBZjtBQUNBLFVBQU1DLE9BQUssVUFBWDtBQUNBLFVBQU1DLE9BQUssQ0FBQyxZQUFELEVBQWMsTUFBZCxDQUFYO0FBQ0EsVUFBTUMsUUFBTSxDQUFaO0FBQ0EsVUFBTUMsYUFBVyxDQUFqQjtBQUNBLFVBQU1DLFFBQU0sSUFBSVgsS0FBSixDQUFVLEVBQUVLLFNBQUYsRUFBYUMsUUFBYixFQUF1QkMsSUFBdkIsRUFBNkJDLElBQTdCLEVBQW1DQyxLQUFuQyxFQUEwQ0MsVUFBMUMsRUFBVixDQUFaOztBQUVBRSxPQUFHLGlEQUFILEVBQXFELE1BQUk7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QUFFMUJOLDJCQUFXTSxNQUFNTixTQUFOLEdBQWtCSixTQUFsQixHQUE0QjtBQUZiLGFBQXZCLENBQVAsRUFHSWEsT0FISixDQUdZSCxNQUFNRCxVQUFOLEdBQWlCLENBSDdCO0FBSUgsU0FMRDtBQU1BRSxXQUFHLGdEQUFILEVBQW9ELE1BQUk7QUFDcERDLG1CQUFPYixNQUFNNkIsZ0JBQU4sQ0FBdUI7QUFDMUJDLCtCQUFlbkIsS0FEVztBQUUxQk4sMkJBQVdNLE1BQU1OLFNBQU4sR0FBa0JKLFNBQWxCLEdBQTRCO0FBRmIsYUFBdkIsQ0FBUCxFQUdJYSxPQUhKLENBR1lILE1BQU1ELFVBQU4sR0FBaUIsQ0FIN0I7QUFJSCxTQUxEO0FBTUFFLFdBQUcsd0JBQUgsRUFBNEIsTUFBSTtBQUM1QkQsa0JBQU1ELFVBQU4sR0FBaUIsQ0FBQyxDQUFsQjtBQUNBRyxtQkFBT2IsTUFBTTZCLGdCQUFOLENBQXVCLEVBQUNDLGVBQWNuQixLQUFmLEVBQXZCLENBQVAsRUFBc0RHLE9BQXRELENBQThELENBQTlEO0FBQ0gsU0FIRDtBQUlILEtBakJEO0FBa0JILENBdkZEIiwiZmlsZSI6ImJsb2NrLnRlc3QuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBoZXhUb0JpbmFyeT1yZXF1aXJlKCdoZXgtdG8tYmluYXJ5Jyk7XG5jb25zdCBCbG9jaz1yZXF1aXJlKCcuL2Jsb2NrJyk7XG5jb25zdCB7TUlORV9SQVRFLEdFTkVTSVNfREFUQX09cmVxdWlyZSgnLi4vY29uZmlnJyk7XG5jb25zdCBjcnlwdG9IYXNoPXJlcXVpcmUoJy4uL3V0aWwvY3J5cHRvLWhhc2gnKTtcblxuZGVzY3JpYmUoJ0Jsb2NrJywoKT0+e1xuICAgIGNvbnN0IHRpbWVzdGFtcD0yMDAwO1xuICAgIGNvbnN0IGxhc3RIYXNoPSdmb28taGFzaCc7XG4gICAgY29uc3QgaGFzaD0nYmFyLWhhc2gnO1xuICAgIGNvbnN0IGRhdGE9WydibG9ja2NoYWluJywnZGF0YSddO1xuICAgIGNvbnN0IG5vbmNlPTE7XG4gICAgY29uc3QgZGlmZmljdWx0eT0xO1xuICAgIGNvbnN0IGJsb2NrPW5ldyBCbG9jayh7IHRpbWVzdGFtcCwgbGFzdEhhc2gsIGhhc2gsIGRhdGEsIG5vbmNlLCBkaWZmaWN1bHR5IH0pO1xuXG4gICAgaXQoJ2hhcyBhIHRpbWVzdGFtcCxsYXN0aGFzaCxoYXNoIGFuZCBkYXRhIHByb3BlcnR5JywoKT0+e1xuICAgICAgICBleHBlY3QoYmxvY2sudGltZXN0YW1wKS50b0VxdWFsKHRpbWVzdGFtcCk7XG4gICAgICAgIGV4cGVjdChibG9jay5sYXN0SGFzaCkudG9FcXVhbChsYXN0SGFzaCk7XG4gICAgICAgIGV4cGVjdChibG9jay5oYXNoKS50b0VxdWFsKGhhc2gpO1xuICAgICAgICBleHBlY3QoYmxvY2suZGF0YSkudG9FcXVhbChkYXRhKTtcbiAgICAgICAgZXhwZWN0KGJsb2NrLm5vbmNlKS50b0VxdWFsKG5vbmNlKTtcbiAgICAgICAgZXhwZWN0KGJsb2NrLmRpZmZpY3VsdHkpLnRvRXF1YWwoZGlmZmljdWx0eSlcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCdnZW5lc2lzKCknLCgpPT57XG4gICAgICAgIGNvbnN0IGdlbmVzaXNCbG9jayA9QmxvY2suZ2VuZXNpcygpO1xuICAgICAgICBjb25zb2xlLmxvZyhcImdlbmVzaXNCbG9jay0tLT5cIixnZW5lc2lzQmxvY2spO1xuXG4gICAgICAgIGl0KCdyZXR1cm5zIGEgQmxvY2sgaW5zdGFuY2UnLCgpPT57XG4gICAgICAgICAgICBleHBlY3QoZ2VuZXNpc0Jsb2NrIGluc3RhbmNlb2YgQmxvY2spLnRvQmUodHJ1ZSk7XG4gICAgICAgIH0pO1xuICAgICAgICBpdCgncmV0dXJucyB0aGUgZ2VuZXNpcyBkYXRhJywoKT0+e1xuICAgICAgICAgICAgZXhwZWN0KGdlbmVzaXNCbG9jaykudG9FcXVhbChHRU5FU0lTX0RBVEEpO1xuICAgICAgICB9KVxuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ21pbmVCbG9jaygpJywoKT0+e1xuICAgICAgICBjb25zdCBsYXN0QmxvY2s9QmxvY2suZ2VuZXNpcygpO1xuICAgICAgICBjb25zdCBkYXRhPSdtaW5lZCBkYXRhJztcbiAgICAgICAgY29uc3QgbWluZWRCbG9jaz1CbG9jay5taW5lQmxvY2soe2xhc3RCbG9jayxkYXRhfSlcblxuICAgICAgICBpdCgncmV0dXJucyBhIEJsb2NrIGluc3RhbmNlJywoKT0+e1xuICAgICAgICAgICAgZXhwZWN0KG1pbmVkQmxvY2sgaW5zdGFuY2VvZiBCbG9jaykudG9CZSh0cnVlKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGl0KCdzZXRzIHRoZSBgbGFzdEhhc2hgIHRvIGJlIHRoZSBgaGFzaGAgb2YgdGhlIGBsYXN0QmxvY2tgJywoKT0+e1xuICAgICAgICAgICAgZXhwZWN0KG1pbmVkQmxvY2subGFzdEhhc2gpLnRvRXF1YWwobGFzdEJsb2NrLmhhc2gpO1xuICAgICAgICB9KVxuICAgICAgICBpdCgnc2V0cyB0aGUgYGRhdGFgJywoKT0+e1xuICAgICAgICAgICAgZXhwZWN0KG1pbmVkQmxvY2suZGF0YSkudG9FcXVhbChkYXRhKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGl0KCdzZXRzIGEgYHRpbWVzdGFtcGAnLCgpPT57XG4gICAgICAgICAgICBleHBlY3QobWluZWRCbG9jay50aW1lc3RhbXApLm5vdC50b0VxdWFsKHVuZGVmaW5lZCk7XG4gICAgICAgIH0pXG4gICAgICAgIGl0KCdjcmVhdGVzIGEgU0hBLTI1NiBgaGFzaGAgYmFzZWQgb24gcHJvcGVyIGlucHV0cycsKCk9PntcbiAgICAgICAgICAgIGV4cGVjdChtaW5lZEJsb2NrLmhhc2gpXG4gICAgICAgICAgICAgICAgLnRvRXF1YWwoXG4gICAgICAgICAgICAgICAgICAgIGNyeXB0b0hhc2goXG4gICAgICAgICAgICAgICAgICAgICAgICBtaW5lZEJsb2NrLnRpbWVzdGFtcCxcbiAgICAgICAgICAgICAgICAgICAgICAgIG1pbmVkQmxvY2subm9uY2UsXG4gICAgICAgICAgICAgICAgICAgICAgICBtaW5lZEJsb2NrLmRpZmZpY3VsdHksXG4gICAgICAgICAgICAgICAgICAgICAgICBsYXN0QmxvY2suaGFzaCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuICAgICAgICBpdCgnc2V0cyBhIGBoYXNoYCB0aGF0IG1hdGNoZXMgdGhlIGRpZmZpY3VsdHkgY3JpdGVyaWEnLCgpPT57XG4gICAgICAgICAgICBleHBlY3QoaGV4VG9CaW5hcnkobWluZWRCbG9jay5oYXNoKS5zdWJzdHJpbmcoMCxtaW5lZEJsb2NrLmRpZmZpY3VsdHkpKVxuICAgICAgICAgICAgICAgIC50b0VxdWFsKCcwJy5yZXBlYXQobWluZWRCbG9jay5kaWZmaWN1bHR5KSk7XG4gICAgICAgIH0pO1xuICAgICAgICBpdCgnYWRqdXN0cyB0aGUgZGlmZmljdWx0eScsKCk9PntcbiAgICAgICAgICAgIGNvbnN0IHBvc3NpYmxlUmVzdWx0cyA9IFtsYXN0QmxvY2suZGlmZmljdWx0eSsxLGxhc3RCbG9jay5kaWZmaWN1bHR5LTFdO1xuICAgICAgICAgICAgZXhwZWN0KHBvc3NpYmxlUmVzdWx0cy5pbmNsdWRlcyhtaW5lZEJsb2NrLmRpZmZpY3VsdHkpKS50b0JlKHRydWUpO1xuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCdhZGp1c3REaWZmaWN1bHR5JywoKT0+e1xuICAgICAgICBpdCgncmFpc2VzIHRoZSBkaWZmaWN1bHR5IGZvciBhIHF1aWNrbHkgbWluZWQgYmxvY2snLCgpPT57XG4gICAgICAgICAgICBleHBlY3QoQmxvY2suYWRqdXN0RGlmZmljdWx0eSh7XG4gICAgICAgICAgICAgICAgb3JpZ2luYWxCbG9jazogYmxvY2ssXG4gICAgICAgICAgICAgICAgdGltZXN0YW1wOiBibG9jay50aW1lc3RhbXAgKyBNSU5FX1JBVEUtMTAwXG4gICAgICAgICAgICB9KSkudG9FcXVhbChibG9jay5kaWZmaWN1bHR5KzEpXG4gICAgICAgIH0pO1xuICAgICAgICBpdCgnbG93ZXJzIHRoZSBkaWZmaWN1bHR5IGZvciBhIHNsb3dseSBtaW5lZCBibG9jaycsKCk9PntcbiAgICAgICAgICAgIGV4cGVjdChCbG9jay5hZGp1c3REaWZmaWN1bHR5KHtcbiAgICAgICAgICAgICAgICBvcmlnaW5hbEJsb2NrOiBibG9jayxcbiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IGJsb2NrLnRpbWVzdGFtcCArIE1JTkVfUkFURSsxMDBcbiAgICAgICAgICAgIH0pKS50b0VxdWFsKGJsb2NrLmRpZmZpY3VsdHktMSlcbiAgICAgICAgfSk7XG4gICAgICAgIGl0KCdoYXMgYSBsb3dlciBsaW1pdCBvZiAxJywoKT0+e1xuICAgICAgICAgICAgYmxvY2suZGlmZmljdWx0eT0tMTtcbiAgICAgICAgICAgIGV4cGVjdChCbG9jay5hZGp1c3REaWZmaWN1bHR5KHtvcmlnaW5hbEJsb2NrOmJsb2NrfSkpLnRvRXF1YWwoMSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xufSk7Il19